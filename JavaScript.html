<script>
// Funciones para Google Apps Script
// Todas estas funciones se ejecutan en el cliente

/**
 * Variables globales del lado del cliente
 */
var allResults = [];
var currentPage = 1;
var loadingInterval = null;

/**
 * Inicializa la aplicaci√≥n cuando el DOM est√° listo
 */
function inicializarApp() {
  mostrarHistorial();
  
  // Agregar event listeners para Enter
  var matriculaInput = document.getElementById("matricula");
  var apellidoInput = document.getElementById("apellido");
  
  if (matriculaInput) {
    matriculaInput.addEventListener('keydown', handleKeyDown);
  }
  
  if (apellidoInput) {
    apellidoInput.addEventListener('keydown', handleKeyDown);
  }
}

/**
 * Maneja el evento keydown para b√∫squeda con Enter
 */
function handleKeyDown(event) {
  if (event.keyCode === 13) {
    buscarCreditos();
  }
}

/**
 * Oculta el loader con animaci√≥n suave
 */
function hideLoader() {
  var loader = document.getElementById("loader");
  if (loader) {
    loader.style.opacity = "0";
    setTimeout(function() {
      loader.style.display = "none";
    }, CONFIG.LOADER_FADE_DURATION);
  }
}

/**
 * Muestra mensajes de carga rotativos
 */
function iniciarMensajesCarga() {
// Los mensajes de carga ahora se obtienen desde CONFIG.LOADING_MESSAGES  var mensajeCarga = document.getElementById("mensajeCarga");
  if (!mensajeCarga) return;

  var index = 0;
  loadingInterval = setInterval(function() {
    mensajeCarga.textContent = CONFIG.LOADING_MESSAGES[index];
    index = (index + 1) % CONFIG.LOADING_MESSAGES.length;
  }, CONFIG.LOADER_MESSAGE_INTERVAL);

  return loadingInterval;
}

/**
 * Detiene los mensajes de carga
 */
function detenerMensajesCarga() {
  if (loadingInterval) {
    clearInterval(loadingInterval);
    loadingInterval = null;
  }
}

/**
 * Valida la matr√≠cula ingresada
 */
function validarMatricula(matricula) {
  var matriculaRegex = /^[a-zA-Z0-9]+$/;
  return matricula === "" || matriculaRegex.test(matricula);
}

/**
 * Valida el apellido ingresado
 */
function validarApellido(apellido) {
  return apellido === "" || apellido.length >= CONFIG.MIN_APELLIDO_LENGTH;
}

/**
 * Muestra errores de validaci√≥n
 */
function mostrarError(campo, mensaje) {
  if (typeof mensaje === 'undefined') {
    mensaje = null;
  }
  var errorElement = document.getElementById(campo + "Error");
  if (errorElement) {
    if (mensaje) {
      errorElement.textContent = mensaje;
    }
    errorElement.classList.remove("d-none");
  }
}

/**
 * Oculta todos los errores de validaci√≥n
 */
function ocultarErrores() {
  var errores = ['matriculaError', 'apellidoError'];
  errores.forEach(function(errorId) {
    var errorElement = document.getElementById(errorId);
    if (errorElement) {
      errorElement.classList.add("d-none");
    }
  });
}

/**
 * Funci√≥n principal de b√∫squeda de cr√©ditos
 */
function buscarCreditos() {
  var matricula = document.getElementById("matricula").value.trim();
  var apellido = document.getElementById("apellido").value.trim();
  var loader = document.getElementById("loader");

  // Limpiar errores previos
  ocultarErrores();

  // Validaciones
  if (!validarMatricula(matricula)) {
    mostrarError('matricula');
    return;
  }

  if (!validarApellido(apellido)) {
    mostrarError('apellido');
    return;
  }

  if (matricula === "" && apellido === "") {
    mostrarError('matricula', "Por favor ingrese una matr√≠cula o apellido para buscar.");
    return;
  }

  // Mostrar loader
  if (loader) {
    loader.style.display = "block";
    loader.style.opacity = "1";
  }

  // Iniciar mensajes de carga
  iniciarMensajesCarga();

  // Realizar b√∫squeda
  if (matricula) {
    buscarPorMatricula(matricula);
  } else {
    buscarPorApellido(apellido);
  }
}

/**
 * Busca cr√©ditos por matr√≠cula
 * @param {string} matricula - Matr√≠cula del estudiante
 */
function buscarPorMatricula(matricula) {
  google.script.run
    .withSuccessHandler(function(result) {
      detenerMensajesCarga();
      hideLoader();
      displayResults(result);
      guardarEnHistorial("matricula", matricula);
    })
    .withFailureHandler(function(error) {
      detenerMensajesCarga();
      hideLoader();
      mostrarErrorBusqueda(error);
    })
    .buscarCreditos(matricula);
}

/**
 * Busca cr√©ditos por apellido
 * @param {string} apellido - Apellido del estudiante
 */
function buscarPorApellido(apellido) {
  google.script.run
    .withSuccessHandler(function(results) {
      detenerMensajesCarga();
      hideLoader();
      displayResults(results);
      guardarEnHistorial("apellido", apellido);
    })
    .withFailureHandler(function(error) {
      detenerMensajesCarga();
      hideLoader();
      mostrarErrorBusqueda(error);
    })
    .buscarCreditosPorApellido(apellido);
}

/**
 * Muestra error de b√∫squeda
 */
function mostrarErrorBusqueda(error) {
  var resultadoDiv = document.getElementById("resultado");
  if (resultadoDiv) {
    resultadoDiv.innerHTML = 
      '<div class="alert alert-danger">' +
        '<h5>‚ùå Error en la b√∫squeda</h5>' +
        '<p>Error: ' + (error.message || 'No se encontraron resultados') + '</p>' +
        '<hr>' +
        '<p class="mb-0"><strong>Intenta nuevamente</strong> o contacta al DEI si el problema persiste.</p>' +
      '</div>';
  }
}

/**
 * Valida si una URL es v√°lida
 */
function esURLValida(url) {
  if (!url || typeof url !== 'string') return false;
  url = url.trim();
  // Acepta enlaces de Google Drive aunque tengan par√°metros extra
  var driveRegex = /^https?:\/\/(drive|docs)\.google\.com\//i;
  try {
    var parsed = new URL(url);
    if (['http:', 'https:'].includes(parsed.protocol)) {
      // Si es Google Drive, lo acepta aunque tenga par√°metros
      if (driveRegex.test(url)) return true;
      // Si es otro enlace, debe ser v√°lido
      return true;
    }
    return false;
  } catch (e) {
    // Si no se puede parsear, pero parece Google Drive, lo acepta
    if (driveRegex.test(url)) return true;
    return false;
  }
}

/**
 * Limpia HTML de una cadena de texto
 */
function limpiarHTML(htmlString) {
  var div = document.createElement('div');
  div.innerHTML = htmlString;
  return div.textContent || div.innerText || '';
}

/**
 * Muestra los resultados de la b√∫squeda
 */
function displayResults(results) {
  // Registrar en consola para depuraci√≥n
  console.log("Datos recibidos:", results);
  
  allResults = Array.isArray(results) ? results : [results];
  currentPage = 1;
  renderTablaPaginada();
}

/**
 * Crea una barra de progreso visual
 */
function crearBarra(actual, maximo, categoria) {
  var porcentaje = Math.min((actual / maximo) * 100, 100);
  var color = porcentaje === 100 ? '#28a745' : porcentaje >= 75 ? '#ffc107' : '#dc3545';
  
  return '<div style="position: relative;">' +
    '<span style="font-weight: bold;">' + actual + '/' + maximo + '</span>' +
    '<div style="width: 100%; height: 6px; background-color: #e9ecef; border-radius: 3px; margin-top: 3px;">' +
      '<div style="width: ' + porcentaje + '%; height: 100%; background-color: ' + color + '; border-radius: 3px; transition: width 0.3s ease;"></div>' +
    '</div>' +
  '</div>';
}

/**
 * Construye una fila de la tabla de resultados
 */
function construirFila(data) {
  var nombreLimpio = limpiarHTML(data.nombreAlumno || '');
  var enlace = typeof data.enlaceAlumno === 'string' ? data.enlaceAlumno.trim() : '';
  var enlaceValido = esURLValida(enlace);
  var detalleHtml = '';
  if (enlaceValido) {
    detalleHtml = '<a href="' + enlace + '" target="_blank" class="detail-btn btn btn-primary">Ver Detalles</a>';
  } else {
    detalleHtml = '<button class="detail-btn btn btn-secondary" disabled style="opacity:0.7;cursor:not-allowed;">Sin detalles disponibles</button>';
  }
  
  var totalCreditos = data.cantidadCreditoAlumnoTotal || 0;
  var creditosColor = totalCreditos >= 20 ? '#28a745' : '#dc3545';
  var creditosTexto = totalCreditos >= 20 ? ' ‚úÖ' : ' (Faltan ' + (20 - totalCreditos) + ')';
  
  // Verificaci√≥n m√°s robusta para determinar si la suficiencia en ingl√©s est√° aprobada
  var aprobado = false;
  if (data.AprobacionSI) {
    var valor = String(data.AprobacionSI).toLowerCase();
    aprobado = valor === 's√≠' || valor === 'si' || valor === 'yes' || valor === 'true' || valor === '1' || valor === 'aprobado';
  }
  var aprobacionColor = aprobado ? '#28a745' : '#dc3545';
  var aprobacionIcono = aprobado ? '‚úÖ' : '‚ùå';

  return '<tr>' +
      '<td>' + nombreLimpio + '</td>' +
      '<td>' + (data.carrera || '') + '</td>' +
      '<td style="text-align: center; color: ' + aprobacionColor + '; font-weight: bold;">' +
        (aprobado ? 'APROBADO ' : 'NO APROBADO ') + aprobacionIcono +
      '</td>' +
      '<td>' + crearBarra(data.MateriasCursos || 0, 12, 'A') + '</td>' +
      '<td>' + crearBarra(data.Congresos || 0, 4, 'B') + '</td>' +
      '<td>' + crearBarra(data.AyudantiasPasantias || 0, 10, 'C') + '</td>' +
      '<td>' + crearBarra(data.Investigacion || 0, 2, 'D') + '</td>' +
      '<td>' + crearBarra(data.Extension || 0, 10, 'E') + '</td>' +
      '<td>' + crearBarra(data.Otros || 0, 4, 'F') + '</td>' +
      '<td style="font-weight: bold; color: ' + creditosColor + ';">' +
        totalCreditos + '/20' + creditosTexto +
      '</td>' +
    '</tr>' +
    '<tr><td colspan="10" class="text-center">' + detalleHtml + '</td></tr>';
}

/**
 * Renderiza la tabla con paginaci√≥n
 */
function renderTablaPaginada() {
  var resultadoDiv = document.getElementById("resultado");
  var RESULTS_PER_PAGE = CONFIG.RESULTS_PER_PAGE;
  
  if (!resultadoDiv) return;

  // Validaci√≥n extendida: sin resultados, array vac√≠o, o solo objetos vac√≠os
  var datosValidos = Array.isArray(allResults) && allResults.some(function(obj) {
    if (!obj || typeof obj !== 'object') return false;
    // Considera vac√≠o si no tiene nombre, carrera ni cr√©ditos
    return Object.keys(obj).length > 0 && (obj.nombreAlumno || obj.carrera || obj.cantidadCreditoAlumnoTotal);
  });

  if (!allResults || allResults.length === 0 || !datosValidos) {
    resultadoDiv.innerHTML = 
      '<div class="alert alert-warning text-center">' +
        '<h5>üì≠ Alumno no encontrado</h5>' +
        '<p>No se encontr√≥ informaci√≥n de cr√©ditos para la matr√≠cula ingresada.</p>' +
        '<hr>' +
        '<p class="mb-0">Verifica que la matr√≠cula est√© correctamente escrita.<br>' +
        'Si crees que es un error, contacta al DEI.</p>' +
      '</div>';
    return;
  }

  var totalPages = Math.ceil(allResults.length / RESULTS_PER_PAGE);
  var start = (currentPage - 1) * RESULTS_PER_PAGE;
  var end = start + RESULTS_PER_PAGE;
  var datosPagina = allResults.slice(start, end);


  // Obtenemos el nombre del alumno para el t√≠tulo del PDF
  var nombreAlumno = allResults.length > 0 ? limpiarHTML(allResults[0].nombreAlumno || 'Alumno') : 'Alumno';
  
  var tableHtml = 
    '<div id="resultados-container" class="mt-4">' +
      '<div class="d-flex justify-content-between align-items-center mb-3">' +
        '<h4 class="mb-0">Resultados de la consulta</h4>' +
        '<button id="btnExportarPDF" class="btn btn-danger" onclick="exportarAPDF(\'' + nombreAlumno + '\')"><i class="bi bi-file-earmark-pdf"></i> Exportar a PDF</button>' +
      '</div>' +
      '<div class="table-responsive" id="tabla-resultados">' +
        '<table class="table table-bordered table-striped" style="background-color: #C8CBD4; color: #000;">' +
          '<thead style="background-color: #AEB1BD; font-weight: bold;">' +
            '<tr>' +
              '<th>Alumno/a</th>' +
              '<th>Carrera</th>' +
              '<th>Suficiencia en Ingl√©s<br><span class="requisito-obligatorio">(Requisito obligatorio)</span></th>' +
              '<th>Cursos Optativos (A) m√°x: 12</th>' +
              '<th>Conferencias/Congresos/Seminarios (B) m√°x: 4</th>' +
              '<th>Ayudant√≠as de C√°tedra (C) m√°x: 10</th>' +
              '<th>Extensi√≥n Universitaria (D) m√°x: 2</th>' +
              '<th>Pasant√≠as Supervizadas (E) m√°x: 10<br><span class="requisito-obligatorio">(Obligatorio)</span></th>' +
              '<th>Otros (F) m√°x: 4</th>' +
              '<th>Total Cr√©ditos<br><span class="requisito-obligatorio">(Meta: 20)</span></th>' +
            '</tr>' +
          '</thead>' +
          '<tbody>' +
            datosPagina.map(construirFila).join('') +
          '</tbody>' +
        '</table>' +
      '</div>' +
      '<div class="text-center mt-3">' +
        renderPaginacion(totalPages) +
      '</div>' +
    '</div>';

  resultadoDiv.innerHTML = tableHtml;
}

/**
 * Renderiza los botones de paginaci√≥n
 */
function renderPaginacion(totalPages) {
  var botones = '';
  for (var i = 1; i <= totalPages; i++) {
    botones += '<button class="pagination-btn ' + (i === currentPage ? 'active' : '') + '" onclick="irAPagina(' + i + ')">' + i + '</button>';
  }
  return botones;
}

/**
 * Navega a una p√°gina espec√≠fica
 */
function irAPagina(pagina) {
  currentPage = pagina;
  renderTablaPaginada();
}

/**
 * Guarda una b√∫squeda en el historial
 */
function guardarEnHistorial(tipo, valor) {
  if (!valor || !tipo) return;
  
  var clave = "historial-" + tipo;
  var historial = JSON.parse(localStorage.getItem(clave)) || [];
  var MAX_HISTORIAL_ITEMS = CONFIG.MAX_HISTORIAL_ITEMS;
  
  // Eliminar si ya existe
  historial = historial.filter(function(item) {
    return item !== valor;
  });
  
  // Agregar al inicio
  historial.unshift(valor);
  
  // Mantener solo los √∫ltimos elementos
  historial = historial.slice(0, MAX_HISTORIAL_ITEMS);
  
  localStorage.setItem(clave, JSON.stringify(historial));
  mostrarHistorial();
}

/**
 * Muestra el historial de b√∫squedas
 */
function mostrarHistorial() {
  var historialDiv = document.getElementById("historialLista");
  if (!historialDiv) return;

  historialDiv.innerHTML = '';
  
  var matriculas = JSON.parse(localStorage.getItem("historial-matricula")) || [];
  var apellidos = JSON.parse(localStorage.getItem("historial-apellido")) || [];
  var MAX_HISTORIAL_ITEMS = CONFIG.MAX_HISTORIAL_ITEMS;
  
  var matriculasConTipo = matriculas.map(function(m) {
    return { tipo: 'matricula', valor: m };
  });
  var apellidosConTipo = apellidos.map(function(a) {
    return { tipo: 'apellido', valor: a };
  });
  var todos = matriculasConTipo.concat(apellidosConTipo);

  todos.slice(0, MAX_HISTORIAL_ITEMS).forEach(function(item) {
    var li = document.createElement('li');
    li.className = 'list-group-item list-group-item-action';
    li.textContent = item.valor + ' (' + item.tipo + ')';
    li.style.cursor = 'pointer';
    li.onclick = function() {
      if (item.tipo === 'matricula') {
        document.getElementById("matricula").value = item.valor;
        document.getElementById("apellido").value = '';
      } else {
        document.getElementById("apellido").value = item.valor;
        document.getElementById("matricula").value = '';
      }
      buscarCreditos();
    };
    historialDiv.appendChild(li);
  });
}

/**
 * Muestra/oculta detalles de categor√≠as
 */
function toggleDetails(detailsId) {
  var detailsElement = document.getElementById(detailsId);
  var button = event.target;
  
  if (!detailsElement || !button) return;
  
  if (detailsElement.classList.contains('show')) {
    detailsElement.classList.remove('show');
    button.textContent = 'Ver m√°s detalles';
    button.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
  } else {
    detailsElement.classList.add('show');
    button.textContent = 'Ocultar detalles';
    button.style.background = 'linear-gradient(135deg, #dc3545 0%, #fd7e14 100%)';
  }
}

/**
 * Exporta los resultados a un archivo PDF
 * @param {string} nombreAlumno - Nombre del alumno para incluir en el t√≠tulo del PDF
 */
function exportarAPDF(nombreAlumno) {
  // Mostrar indicador de carga durante la generaci√≥n del PDF
  var resultadoDiv = document.getElementById("resultado");
  var resultadosContainer = document.getElementById("resultados-container");
  var loadingOverlay = document.createElement("div");
  loadingOverlay.className = "pdf-loading-overlay";
  loadingOverlay.innerHTML = 
    '<div class="pdf-loading-content">' +
      '<div class="spinner"></div>' +
      '<p>Generando PDF, por favor espere...</p>' +
    '</div>';
  resultadoDiv.appendChild(loadingOverlay);
  
  try {
    // Importamos jsPDF desde el objeto global
    var { jsPDF } = window.jspdf;

    setTimeout(function() {
      // Creamos una instancia de jsPDF en formato vertical
      var doc = new jsPDF('portrait', 'mm', 'a4');
      
      // Obtenemos el ancho central de la p√°gina
      var pageWidth = doc.internal.pageSize.getWidth();
      var centerX = pageWidth / 2;
      
      // Agregamos un t√≠tulo al PDF
      doc.setFontSize(18);
      doc.text("Cr√©ditos Acad√©micos DEI", centerX, 15, { align: 'center' });
      
      // Agregamos el nombre del alumno
      doc.setFontSize(14);
      doc.text("Informe de: " + nombreAlumno, centerX, 25, { align: 'center' });
      
      // Agregamos la fecha
      var fecha = new Date().toLocaleDateString('es-ES');
      doc.setFontSize(10);
      doc.text("Fecha de generaci√≥n: " + fecha, centerX, 32, { align: 'center' });
      
      // Obtenemos la tabla y preparamos para capturarla correctamente
      var tablaResultados = document.getElementById('tabla-resultados');
      
      // SOLUCI√ìN PARA DISPOSITIVOS M√ìVILES: 
      // 1. Guardar el estilo original
      var estiloOriginal = tablaResultados.style.cssText;
      
      // 2. Forzar ancho completo temporalmente durante la captura
      tablaResultados.style.width = "100%";
      tablaResultados.style.maxWidth = "none";
      tablaResultados.style.overflow = "visible";
      
      // 3. Si es un dispositivo m√≥vil, ajustar el tama√±o para mejor captura
      var esMobile = window.innerWidth < 768;
      if (esMobile) {
        // Agregar estilos temporales para la captura en m√≥vil
        tablaResultados.style.transform = "scale(1)";
        tablaResultados.style.transformOrigin = "top left";
      }
      
      // Utilizamos html2canvas con opciones mejoradas
      html2canvas(tablaResultados, {
        scale: esMobile ? 1.5 : 2, // Mayor escala para dispositivos m√≥viles
        useCORS: true,
        logging: false,
        allowTaint: true,
        scrollX: 0,
        scrollY: 0,
        width: tablaResultados.scrollWidth, // Captura todo el ancho
        height: tablaResultados.scrollHeight, // Captura toda la altura
        windowWidth: document.documentElement.offsetWidth,
        windowHeight: document.documentElement.offsetHeight
      }).then(function(canvas) {
        // Restaurar los estilos originales
        tablaResultados.style.cssText = estiloOriginal;
        
        var imgData = canvas.toDataURL('image/png');
        
        // Calculamos el ancho y alto para mantener la relaci√≥n de aspecto
        var pageWidth = doc.internal.pageSize.getWidth();
        var pageHeight = doc.internal.pageSize.getHeight();
        var imgWidth = pageWidth - 20; // Margen de 10mm en cada lado
        var imgHeight = canvas.height * imgWidth / canvas.width;
        
        // En formato vertical, es m√°s probable que la imagen sea demasiado alta
        // Ajustamos para que quepa con m√°s margen para los textos
        var margenSuperior = 40; // Espacio para t√≠tulo y datos (en mm)
        var margenInferior = 15; // Espacio para pie de p√°gina (en mm)
        var espacioDisponible = pageHeight - margenSuperior - margenInferior;
        
        if (imgHeight > espacioDisponible) {
          imgHeight = espacioDisponible;
          imgWidth = canvas.width * imgHeight / canvas.height;
          
          // Centramos horizontalmente si la imagen es m√°s angosta que la p√°gina
          var margenLateral = (pageWidth - imgWidth) / 2;
        } else {
          var margenLateral = 10; // Margen predeterminado
        }
        
        // Agregamos la imagen al PDF centrada horizontalmente
        doc.addImage(imgData, 'PNG', margenLateral, margenSuperior, imgWidth, imgHeight);
        
        // Agregamos pie de p√°gina
        doc.setFontSize(8);
        var centerX = pageWidth / 2;
        doc.text("Universidad Cat√≥lica \"Nuestra Se√±ora de la Asunci√≥n\" - DEI - By OI", centerX, pageHeight - 10, { align: 'center' });
        
        // Guardamos el PDF
        doc.save("Creditos_" + nombreAlumno.replace(/\s+/g, '_') + ".pdf");
        
        // Quitamos el indicador de carga
        resultadoDiv.removeChild(loadingOverlay);
      });
    }, 500);
  } catch (error) {
    console.error("Error al generar el PDF:", error);
    alert("Ha ocurrido un error al generar el PDF. Por favor, intenta nuevamente.");
    resultadoDiv.removeChild(loadingOverlay);
  }
}

// Inicializar cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', inicializarApp);
</script>
